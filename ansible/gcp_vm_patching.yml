---
# Ansible Playbook for GCP Ubuntu VM Patching
# This playbook performs OS patching operations on Ubuntu VMs
# Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6

- name: Add VMs to inventory dynamically
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Add hosts from vm_inventory
      add_host:
        name: "{{ item.key }}"
        ansible_host: "{{ item.value.ansible_host }}"
        ansible_user: "{{ item.value.ansible_user }}"
        ansible_ssh_common_args: "{{ item.value.ansible_ssh_common_args | default('-o StrictHostKeyChecking=no') }}"
        groups: gcp_vms
      loop: "{{ vm_inventory.all.hosts | dict2items }}"
      when: vm_inventory is defined

- name: Patch Ubuntu VMs
  hosts: gcp_vms
  become: yes
  gather_facts: yes
  
  vars:
    ansible_user: ubuntu
    apt_cache_valid_time: 3600
    reboot_timeout: 300
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: "{{ apt_cache_valid_time }}"
      register: apt_update_result
      failed_when: false
      tags:
        - update
        - apt
    
    - name: Handle apt update errors
      fail:
        msg: "Failed to update apt cache on {{ inventory_hostname }}: {{ apt_update_result.msg | default('Unknown error') }}"
      when: 
        - apt_update_result is defined
        - apt_update_result.failed is defined
        - apt_update_result.failed
      tags:
        - update
        - error_handling
    
    - name: Upgrade all security packages
      apt:
        upgrade: safe
        autoremove: yes
        autoclean: yes
      register: apt_upgrade_result
      failed_when: false
      tags:
        - upgrade
        - apt
    
    - name: Handle apt upgrade errors
      fail:
        msg: "Failed to upgrade packages on {{ inventory_hostname }}: {{ apt_upgrade_result.msg | default('Unknown error') }}"
      when:
        - apt_upgrade_result is defined
        - apt_upgrade_result.failed is defined
        - apt_upgrade_result.failed
      tags:
        - upgrade
        - error_handling
    
    - name: Report upgrade results
      debug:
        msg: "Package upgrade completed on {{ inventory_hostname }}. Changed: {{ apt_upgrade_result.changed }}"
      when: apt_upgrade_result is defined
      tags:
        - reporting
    
    - name: Check if reboot required
      stat:
        path: /var/run/reboot-required
      register: reboot_required
      tags:
        - reboot
        - check
    
    - name: Report reboot requirement status
      debug:
        msg: "Reboot required on {{ inventory_hostname }}: {{ reboot_required.stat.exists }}"
      tags:
        - reporting
        - reboot
    
    - name: Reboot if required
      reboot:
        msg: "Reboot initiated by Ansible patching playbook"
        reboot_timeout: "{{ reboot_timeout }}"
        pre_reboot_delay: 5
        post_reboot_delay: 30
      when: reboot_required.stat.exists
      register: reboot_result
      failed_when: false
      tags:
        - reboot
    
    - name: Handle reboot errors
      fail:
        msg: "Failed to reboot {{ inventory_hostname }}: {{ reboot_result.msg | default('Reboot timeout or connection error') }}"
      when:
        - reboot_required.stat.exists
        - reboot_result is defined
        - reboot_result.failed is defined
        - reboot_result.failed
      tags:
        - reboot
        - error_handling
    
    - name: Report reboot completion
      debug:
        msg: "System rebooted successfully on {{ inventory_hostname }}"
      when: 
        - reboot_required.stat.exists
        - reboot_result is defined
        - not (reboot_result.failed | default(false))
      tags:
        - reporting
        - reboot
    
    - name: Report patching status
      debug:
        msg: "Patching completed successfully on {{ inventory_hostname }}"
      tags:
        - reporting
