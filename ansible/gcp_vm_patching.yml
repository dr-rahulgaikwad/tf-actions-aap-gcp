---
# Ansible Playbook for GCP Ubuntu VM Patching

- name: Add VMs to inventory dynamically
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Add hosts from vm_inventory
      add_host:
        name: "{{ item.key }}"
        ansible_host: "{{ item.value.ansible_host }}"
        ansible_user: "{{ item.value.ansible_user }}"
        ansible_ssh_common_args: "{{ item.value.ansible_ssh_common_args | default('-o StrictHostKeyChecking=no') }}"
        groups: gcp_vms
      loop: "{{ vm_inventory.all.hosts | dict2items }}"
      when: vm_inventory is defined

- name: Patch Ubuntu VMs
  hosts: gcp_vms
  become: yes
  gather_facts: yes
  
  vars:
    ansible_user: ubuntu
    apt_cache_valid_time: 3600
    reboot_timeout: 300
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: "{{ apt_cache_valid_time }}"
      register: apt_update_result
      failed_when: false
    
    - name: Handle apt update errors
      fail:
        msg: "Failed to update apt cache: {{ apt_update_result.msg | default('Unknown error') }}"
      when: 
        - apt_update_result is defined
        - apt_update_result.failed is defined
        - apt_update_result.failed
    
    - name: Upgrade all security packages
      apt:
        upgrade: safe
        autoremove: yes
        autoclean: yes
      register: apt_upgrade_result
      failed_when: false
    
    - name: Handle apt upgrade errors
      fail:
        msg: "Failed to upgrade packages: {{ apt_upgrade_result.msg | default('Unknown error') }}"
      when:
        - apt_upgrade_result is defined
        - apt_upgrade_result.failed is defined
        - apt_upgrade_result.failed
    
    - name: Report upgrade results
      debug:
        msg: "Package upgrade completed. Changed: {{ apt_upgrade_result.changed }}"
      when: apt_upgrade_result is defined
    
    - name: Check if reboot required
      stat:
        path: /var/run/reboot-required
      register: reboot_required
    
    - name: Reboot if required
      reboot:
        msg: "Reboot initiated by Ansible patching playbook"
        reboot_timeout: "{{ reboot_timeout }}"
        pre_reboot_delay: 5
        post_reboot_delay: 30
      when: reboot_required.stat.exists
      register: reboot_result
      failed_when: false
    
    - name: Handle reboot errors
      fail:
        msg: "Failed to reboot: {{ reboot_result.msg | default('Reboot timeout or connection error') }}"
      when:
        - reboot_required.stat.exists
        - reboot_result is defined
        - reboot_result.failed is defined
        - reboot_result.failed
    
    - name: Report patching status
      debug:
        msg: "Patching completed successfully on {{ inventory_hostname }}"
